"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createFeedsApi = void 0;
const actions = require("./actions");
const piral_core_1 = require("piral-core");
const withFeed_1 = require("./withFeed");
const utils_1 = require("./utils");
/**
 * Creates new Pilet API extensions for supporting simplified data feed connections.
 */
function createFeedsApi(config = {}) {
    return (context) => {
        context.defineActions(actions);
        context.dispatch((state) => (Object.assign(Object.assign({}, state), { feeds: {} })));
        return (_, target) => {
            let feeds = 0;
            return {
                createConnector(resolver) {
                    const id = (0, piral_core_1.buildName)(target.name, feeds++);
                    const options = (0, utils_1.createFeedOptions)(id, resolver);
                    const invalidate = () => {
                        var _a;
                        (_a = options.dispose) === null || _a === void 0 ? void 0 : _a.call(options);
                        context.createFeed(options.id);
                    };
                    if (options.immediately) {
                        context.loadFeed(options);
                    }
                    else {
                        invalidate();
                    }
                    const connect = ((component) => (0, withFeed_1.withFeed)(component, options));
                    Object.keys(options.reducers).forEach((type) => {
                        const reducer = options.reducers[type];
                        if (typeof reducer === 'function') {
                            connect[type] = (...args) => {
                                context.updateFeed(id, args, (data, item) => reducer.call(connect, data, ...item));
                            };
                        }
                    });
                    connect.invalidate = invalidate;
                    return connect;
                },
            };
        };
    };
}
exports.createFeedsApi = createFeedsApi;
//# sourceMappingURL=create.js.map