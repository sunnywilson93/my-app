import * as actions from './actions';
import { buildName } from 'piral-core';
import { withFeed } from './withFeed';
import { createFeedOptions } from './utils';
/**
 * Creates new Pilet API extensions for supporting simplified data feed connections.
 */
export function createFeedsApi(config = {}) {
    return (context) => {
        context.defineActions(actions);
        context.dispatch((state) => (Object.assign(Object.assign({}, state), { feeds: {} })));
        return (_, target) => {
            let feeds = 0;
            return {
                createConnector(resolver) {
                    const id = buildName(target.name, feeds++);
                    const options = createFeedOptions(id, resolver);
                    const invalidate = () => {
                        var _a;
                        (_a = options.dispose) === null || _a === void 0 ? void 0 : _a.call(options);
                        context.createFeed(options.id);
                    };
                    if (options.immediately) {
                        context.loadFeed(options);
                    }
                    else {
                        invalidate();
                    }
                    const connect = ((component) => withFeed(component, options));
                    Object.keys(options.reducers).forEach((type) => {
                        const reducer = options.reducers[type];
                        if (typeof reducer === 'function') {
                            connect[type] = (...args) => {
                                context.updateFeed(id, args, (data, item) => reducer.call(connect, data, ...item));
                            };
                        }
                    });
                    connect.invalidate = invalidate;
                    return connect;
                },
            };
        };
    };
}
//# sourceMappingURL=create.js.map