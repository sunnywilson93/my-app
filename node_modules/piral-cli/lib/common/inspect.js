"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.inspectPilet = exports.inspectPackage = void 0;
const path_1 = require("path");
const archive_1 = require("./archive");
const external_1 = require("../external");
const packageRoot = 'package/';
function getPackageJson(files) {
    const fileName = `${packageRoot}package.json`;
    const fileContent = files[fileName];
    const content = fileContent.toString('utf8');
    return external_1.jju.parse(content);
}
function getPiletMainPath(data, files) {
    const paths = [
        data.main,
        `dist/${data.main}`,
        `${data.main}/index.js`,
        `dist/${data.main}/index.js`,
        'index.js',
        'dist/index.js',
    ];
    return paths.map((filePath) => `${packageRoot}${filePath}`).filter((filePath) => !!files[filePath])[0];
}
function inspectPackage(stream) {
    return (0, archive_1.unpackGzTar)(stream).then((files) => getPackageJson(files));
}
exports.inspectPackage = inspectPackage;
function inspectPilet(stream) {
    return (0, archive_1.unpackGzTar)(stream).then((files) => {
        const data = getPackageJson(files);
        const path = getPiletMainPath(data, files);
        const root = (0, path_1.dirname)(path);
        const main = (0, path_1.basename)(path);
        return Object.assign(Object.assign({}, data), { root,
            main });
    });
}
exports.inspectPilet = inspectPilet;
//# sourceMappingURL=inspect.js.map