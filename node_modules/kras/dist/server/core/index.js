"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MockServerCore = void 0;
const webserver_1 = require("./webserver");
const recorder_1 = require("./recorder");
class MockServerCore extends webserver_1.WebServer {
    constructor(config) {
        super(config);
        this.recorder = new recorder_1.Recorder(16 * 1024);
        for (const evt of ['message', 'broadcast']) {
            this.on(evt, (msg) => {
                const time = new Date();
                this.recorder.message(time, msg);
            });
        }
        this.on('request', (req) => {
            const start = new Date();
            const recordResponse = (res) => {
                const end = new Date();
                this.recorder.hit(start, end, req, res);
                this.removeListener('response', recordResponse);
                this.removeListener('missing', recordMissing);
            };
            const recordMissing = (res) => {
                const end = new Date();
                this.recorder.miss(start, end, req);
                this.removeListener('response', recordResponse);
                this.removeListener('missing', recordMissing);
            };
            this.addListener('response', recordResponse);
            this.addListener('missing', recordMissing);
        });
    }
}
exports.MockServerCore = MockServerCore;
