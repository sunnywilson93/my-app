"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.withFiles = exports.getClient = void 0;
const readFile = require("send");
const path_1 = require("path");
const fs_1 = require("fs");
// this only exists to trick "ncc" -> otherwise it tries to resolve it
// directly at compile-time
const indexHtml = [0].map(() => 'index.html').pop();
function getClient(cwd, path) {
    const fullPath = path_1.resolve(cwd, path);
    if (!fs_1.existsSync(fullPath)) {
        const indexPath = path_1.resolve(fullPath, indexHtml);
        if (fs_1.existsSync(indexPath)) {
            return indexPath;
        }
        try {
            const mainPath = require.resolve(path, {
                paths: [__dirname, process.cwd(), cwd],
            });
            const mainDir = path_1.dirname(mainPath);
            return path_1.resolve(mainDir, indexHtml);
        }
        catch (_a) { }
    }
    return fullPath;
}
exports.getClient = getClient;
function withFiles(server, config) {
    const api = config.api;
    if (api !== false) {
        const prefix = `${api}/static/`;
        const root = path_1.dirname(getClient(config.directory, config.client));
        const options = {
            root,
        };
        server.at(api, 'static/*').get((req, res) => {
            const path = req.url.substr(prefix.length);
            readFile(req, path, options).pipe(res);
        });
    }
}
exports.withFiles = withFiles;
